# Query 30 spot prices from the last 30 days from Uniswap V3 then serve it.


## Overview

A production ready application for fetching last 30 days spot price for a given asset is created.
We are using graph query for fetching the prices.

The alternative way is to use the client "github.com/emersonmacro/go-uniswap-subgraph-client".  
We need to explore the  ListTokenDayDatas method

token_address is passed a query param. So that we can add multiple other filters if needed. 

This service fetches data for only uniswap. Other dex data can be added as well.
We create a separate file in the services dir.
If we need to fetch any other data from Uniswap, we can extend the current file.

** The ApiKey shall come from the secrets file.

### Request

http://localhost:8080/v1/asset/price?token_address=0x1f9840a85d5af5bf1d1762f925bdaddc4201f984

### Response

[
  {
    "timestamp": "2025-01-31",
    "price": "11.90015453681757445081985125684267"
  },.....
]

### Basic outline (I/O, logic, summary of behavior)

We are using the following Query 
{
	tokenDayDatas(
		first: 30, 
		orderBy: date, 
		orderDirection: desc, 
		where: { token: "%s" }
	) {
		date
		priceUSD
	}
}

### Env

env file has to be created as .env.example 
Add your API key to get results

### generate Mocks
Mocks are generated by mockgen in mocks dir. DO NOT change these files

`mockgen -source=services/uniswap_price_service.go -destination=mocks/mock_price_service.go -package=mocks`

### Running Locally

`go build`
`./asset_price`

> ℹ️ All following commands should be run from `asset_price` directory
> unless otherwise stated.

1. Install docker on your machine.
2. `docker build . -t asset_price`
3. `docker run -p 8000:8000 --env-file .env asset_price`

### Deployment

`sudo docker run -d --log-opt max-size=300m --env-file .env --restart=on-failure --platform linux/amd64  asset_price`

### linting

`gofmt -w .`

`go vet ./...`

`golangci-lint run`

### Run tests
Only a sample test case is added. We need to add more test cases to cocer all the corner cases

`go test ./...`

### Improvements

1. Add more test cases
2. Add configs for env variables
3. Handle more errors and wrap it up with error messages
4. Extensive logging has to be added. Need to create a custom logger

